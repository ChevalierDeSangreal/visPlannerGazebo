<!-- 
  PX4 + Gazebo 仿真基础环境启动文件
  
  使用方法：
  1. 启动 PX4 SITL + Gazebo
  2. 启动 MAVROS
  3. 启动目标发布器
-->

<launch>
  <!-- 参数 -->
  <arg name="drone_ns" default="drone0"/>
  <arg name="drone_id" default="0"/>
  <arg name="fcu_url" default="udp://:14540@127.0.0.1:14557"/>
  <arg name="gcs_url" default=""/>
  <arg name="tgt_system" default="1"/>
  <arg name="tgt_component" default="1"/>
  
  <!-- MAVROS节点 -->
  <group ns="$(arg drone_ns)">
    <node pkg="mavros" type="mavros_node" name="mavros" output="screen">
      <param name="fcu_url" value="$(arg fcu_url)"/>
      <param name="gcs_url" value="$(arg gcs_url)"/>
      <param name="target_system_id" value="$(arg tgt_system)"/>
      <param name="target_component_id" value="$(arg tgt_component)"/>
      
      <!-- 启用TF发布 -->
      <param name="tf/send" value="true"/>
      <param name="tf/frame_id" value="map"/>
      <param name="tf/child_frame_id" value="$(arg drone_ns)/base_link"/>
      
      <!-- 系统参数 -->
      <rosparam command="load" file="$(find mavros)/launch/px4_config.yaml"/>
    </node>
  </group>
  
  <!-- 静态TF变换：map -> world (用于RViz可视化) -->
  <node pkg="tf" type="static_transform_publisher" name="map_to_world" 
        args="0 0 0 0 0 0 map world 100"/>
  
  <!-- 目标发布器 
       支持多种轨迹类型：circle, figure8, dshape
       取消注释下面其中一行来选择轨迹类型
  -->
  <!-- Trajectory configuration file selection -->
  <!-- Uncomment ONE of the following lines to select trajectory type -->
  <!-- <arg name="config_file" default="$(find px4_test_framework)/config/target_params.yaml"/>          Circle trajectory -->
  <arg name="config_file" default="$(find px4_test_framework)/config/target_params_figure8.yaml"/> Figure-8 trajectory
  <!-- <arg name="config_file" default="$(find px4_test_framework)/config/target_params_dshape.yaml"/>   D-shape trajectory -->
  
  <node pkg="px4_test_framework" type="target_publisher_node" name="target_publisher" output="screen">
    <rosparam command="load" file="$(arg config_file)"/>
    <param name="drone_id" value="$(arg drone_id)"/>
    <param name="use_sim_time" value="false"/>
    <!-- B-spline轨迹发布参数 -->
    <param name="target_drone_id" value="1"/>  <!-- 目标无人机ID（用于B-spline消息） -->
    <param name="bspline_topic" value="/broadcast_bspline"/>  <!-- B-spline发布话题 -->
    <param name="bspline_duration" value="10.0"/>  <!-- 未来轨迹持续时间 [s] -->
    <param name="bspline_publish_period" value="0.5"/>  <!-- B-spline发布周期 [s] -->
  </node>
  
  <!-- RVIZ可视化（可选） -->
  <arg name="use_rviz" default="true" doc="Whether to launch RViz"/>
  <group if="$(arg use_rviz)">
    <node pkg="rviz" type="rviz" name="rviz" 
          args="-d $(find px4_test_framework)/config/px4_test.rviz" 
          required="false"
          output="screen"/>
  </group>
  
</launch>

